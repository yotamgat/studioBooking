# 🔐 מדריך הפעלת מערכת האימות

## מה נוסף:

✅ התחברות ורישום משתמשים  
✅ אימות עם NextAuth.js  
✅ הצפנת סיסמאות  
✅ הגנה על עמודים (רק למשתמשים מחוברים)  
✅ שימוש ב-userId אמיתי בהזמנות  

---

## 🚀 התקנה והפעלה:

### שלב 1: עדכן את `.env.local`

הוסף את השורות האלה ל-`.env.local`:

```env
# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-super-secret-key-change-this-in-production-min-32-chars
```

**חשוב:** החלף את `NEXTAUTH_SECRET` במחרוזת אקראית ארוכה!  
אפשר ליצור אחת עם:

```bash
openssl rand -base64 32
```

או פשוט:
```
NEXTAUTH_SECRET=my-very-long-secret-key-12345678901234567890
```

### שלב 2: נקה cache והרץ

```powershell
Remove-Item -Recurse -Force .next
npm run dev
```

---

## 📱 איך זה עובד:

### 1. רישום משתמש חדש

**גש ל:**  
http://localhost:3000/auth/register

**מלא:**
- שם מלא
- אימייל
- טלפון (אופציונלי)
- סיסמה (מינימום 6 תווים)
- אימות סיסמה

**לחץ "הירשם"** → אוטומטית מתחבר ועובר לדף הבית

### 2. התחברות

**גש ל:**  
http://localhost:3000/auth/signin

**מלא:**
- אימייל
- סיסמה

**לחץ "התחבר"** → עובר לדף הבית

### 3. הגנה על עמוד ההזמנות

**נסה לגשת ל:**  
http://localhost:3000/booking

**אם לא מחובר** → יעביר אוטומטית ל-/auth/signin  
**אם מחובר** → ייכנס לעמוד ההזמנות

### 4. ההזמנות עכשיו עם משתמש אמיתי

כשיוצרים הזמנה, היא נשמרת עם ה-`userId` של המשתמש המחובר!

---

## 🧪 בדיקות:

### בדיקה 1: רישום והתחברות

1. **הירשם** עם אימייל חדש
2. **בדוק MongoDB Compass** → users collection → המשתמש נוצר
3. **צא** מהמערכת
4. **התחבר** שוב עם אותו אימייל וסיסמה

### בדיקה 2: הגנה על עמודים

1. **צא** מהמערכת (או פתח Incognito)
2. **נסה לגשת** ל-http://localhost:3000/booking
3. **תועבר** אוטומטית להתחברות
4. **התחבר** → תחזור לעמוד ההזמנה

### בדיקה 3: הזמנה עם משתמש אמיתי

1. **התחבר** למערכת
2. **צור הזמנה** מלאה
3. **פתח MongoDB Compass** → bookings collection
4. **בדוק** שה-`userId` הוא ObjectId תקני (לא 000000...)

---

## 🎭 תפקידים (Roles):

המערכת תומכת ב-2 תפקידים:

### Customer (לקוח)
- ברירת מחדל לכל משתמש חדש
- יכול ליצור הזמנות
- יכול לראות את ההזמנות שלו (עתידי)

### Admin (מנהל)
- יש גישה לפאנל ניהול (עתידי)
- יכול לראות את כל ההזמנות
- יכול לאשר/לבטל הזמנות

**ליצור מנהל ידנית:**  
MongoDB Compass → users → ערוך משתמש → שנה `role` מ-`customer` ל-`admin`

---

## 🛡️ אבטחה:

✅ **סיסמאות מוצפנות** - bcrypt עם 12 rounds  
✅ **JWT tokens** - מאובטחים עם NEXTAUTH_SECRET  
✅ **Session management** - 30 ימים (ברירת מחדל)  
✅ **Protected routes** - בדיקת אימות בכל עמוד  

---

## 🔑 פקודות שימושיות:

### יציאה מהמערכת (בקוד)

```typescript
import { signOut } from 'next-auth/react';

signOut({ callbackUrl: '/' });
```

### קבלת המשתמש המחובר

```typescript
import { useSession } from 'next-auth/react';

const { data: session } = useSession();
console.log(session?.user); // { id, email, name, role }
```

### בדיקה אם מחובר

```typescript
const { status } = useSession();
// status: 'loading' | 'authenticated' | 'unauthenticated'
```

---

## 📋 מה הלאה:

עכשיו שיש אימות, אפשר:

1. ✅ **פאנל ניהול** - רשימת הזמנות, אישורים, ביטולים
2. ✅ **"ההזמנות שלי"** - עמוד שמראה למשתמש את ההזמנות שלו
3. ✅ **פרופיל משתמש** - עריכת פרטים, שינוי סיסמה
4. ✅ **שכחתי סיסמה** - איפוס סיסמה במייל

**רוצה להמשיך לפאנל ניהול?** 👨‍💼

---

## ⚠️ שגיאות אפשריות:

### "secret must be provided"
→ חסר NEXTAUTH_SECRET ב-.env.local

### "User not found"
→ האימייל לא קיים במערכת - נסה להירשם קודם

### "Passwords don't match"  
→ בדוק שהסיסמאות זהות ברישום

---

**כל השאלות? שאל!** 💬
